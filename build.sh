#!/usr/bin/env bash

cd /home/bruno/malware
git pull

#VERSION=`fgrep  "Version:" maehdrosagent.spec  | awk '{ print $2}'`
#RELEASE=`fgrep "Release:" maehdrosagent.spec  | awk '{ print $2}' | awk -F\% '{print $1}'`
if ! [ -e "/home/bruno/rpmbuild/SPECS/malware.spec" ]; then
    cp malware.spec /home/bruno/rpmbuild/SPECS
fi

OLDVERSION=`fgrep  "Version:" /home/bruno/rpmbuild/SPECS/malware.spec  | awk '{ print $2}'`
VERSION=`fgrep  "Version:" malware.spec  | awk '{ print $2}'`

if [ "$OLDVERSION" = "$VERSION" ]; then
    OLDRELEASE=`fgrep "Release:" /home/bruno/rpmbuild/SPECS/malware.spec  | awk '{ print $2}' | awk -F\% '{print $1}'`
    NEWRELEASE=`expr $OLDRELEASE + 1`
else
    NEWRELEASE="0"
fi

RELEASE=$NEWRELEASE

#svn commit -m 'Increase' malware.spec

if [ "$HOSTNAME" = "naugrim.maehdros.be" ]; then
    EL="6"
    RELEASEVER="el6"
else
    EL="7"
    RELEASEVER="el7"
fi
echo "EL is $EL"

/bin/cp -f /home/bruno/malware/malware.spec /home/bruno/rpmbuild/SPECS/
sed -i "/Release:/s/Release: .*\%{/Release: $NEWRELEASE%{/" /home/bruno/rpmbuild/SPECS/malware.spec

cd /home/bruno
tar --exclude=.git --exclude=config.json -zcvf rpmbuild/SOURCES/malware.tar.gz malware/
rpmbuild -bb rpmbuild/SPECS/malware.spec

ssh root@repo.maehdros.be /bin/rm -f /opt/repo/centos/$EL/x86_64/malware*
scp rpmbuild/RPMS/noarch/malware-$VERSION-$RELEASE.$RELEASEVER.noarch.rpm root@repo.maehdros.be:/opt/repo/centos/$EL/x86_64

ssh root@repo.maehdros.be /opt/repo/updaterepo.sh



